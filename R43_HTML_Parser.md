# HTML Parser

目前本章已介紹了讀取XLSX、CSV、JSON檔等方法，已經可以讀取幾乎所有的開放資料，也可讀取104、信義房屋、Dcard、facebook、Google Map API、Flickr API、Twitter Rest API等資料。但仍有些網頁是直接由伺服器端傳回整個網頁而非資料檔，例如**PTT網頁版、不動產實價登錄網站、政府標案決標資訊**等等。類似這樣的網頁，我們除了要爬取HTML檔案外，尚須撰寫一個HTML剖析器來獲得其中的資料。絕大部分的網頁都需要用多個\<div\>或者\<table\>或\<li\>等規劃版面以擺放導覽元件、廣告、標題、分類等等各種資訊，資料通常僅佔其中的一小部分，因此我們必須要撰寫HTML剖析器，找到目標的HTML標籤，將之爬取回來。

這類的網站如下，可看出HTML的標籤層層巢套不一，甚至可以為了防止被抓取而動態更改資料巢套的階層，那要如何從這些網站中取得資料呢？雖然說看似複雜，但是也不難看出個規律性，例如新聞搜尋的結果似乎就有標題、簡要內文、時間與圖片。通常，我們的瀏覽器在發出搜尋的要求後，其傳回來的也是一個HTML檔案，也會傳回一些CSS或Javascript來告訴瀏覽器要怎麼視覺化這個HTML檔。所以，這個HTML和CSS是在傳回你的瀏覽器後視覺成該模樣，如果看起來是有規律性的，那意味著必定有一套規律性是設計來讓程式自己知道要怎麼視覺化這些標題或內容，好讓你看起來有規則。而這套規則，簡單地說就是由HTML標籤與屬性所構成的規則，讓我們得以用CSS去選取相同規則的元件，將之視覺化為相同的樣子。

因此，這裡我們除了要弄懂HTML和CSS外，也要介紹CSS Selector和XPath這兩種可以選取HTML元素的方法，CSS Selector和XPath是用來定義一個路徑，選取HTML的一個或者多個條件相同的元素。

## HTML

HTML檔案的結構大致如下：

-   首先會有一個檔案類別的宣告`<!DOCTYPE html>`，用以告訴第三方瀏覽器或應用程式說這是一個HTML5檔案；

-   再來是成對標籤所組成的巢套結構，下例即有一對`<html></html>`包著一對`<head></head>`和一對`<body></body>`。

-   另外`<!---->`包著的內容為註解，瀏覽器或程式遇到該區段的內容會略過不處理。

下圖可用以說明HTML檔案的巢套（一層包一層）結構（圖片來源<https://www.w3schools.com/html/html_intro.asp>）。

## Detecting Element Path

Chrome DevTools的使用如下：

1.  打開Chrome瀏覽器，進入要爬取的網站。

2.  按下F12鍵或「右鍵」點擊網頁上的任意你感興趣的內容並選擇「檢查（Inspector）」來開啟DevTools。

3.  在DevTools中，選擇「Elements」分頁。Elements分頁用於查看和修改網頁的HTML和CSS，以及網頁中的DOM元素。在Elements分頁中可以看到網頁中所有的HTML標籤和屬性，以及網頁中的DOM樹狀結構。程式寫作者可使用此功能來檢查和修改網頁元素，例如更改元素的文本、樣式或屬性，或者添加、刪除或重新排列元素。Elements分頁還提供了選擇元素和檢查元素屬性的工具，便於快速找到和解決網頁問題。此外，Elements分頁還具有許多有用的功能，例如網頁渲染性能分析、Box-Model、色彩選擇器等，可幫助使用者更好地理解和設計網頁。

4.  在「Elements」分頁中找到你要查找的元素，例如一個按鈕或一個超連結。你可以輕點一下Elements中的任意元素，然後按「Ctrl/Cmd+F」就可以搜尋在Elements分頁中的內容。例如你感興趣的是網頁上的「下一頁」三個字，那你搜尋「下一頁」就可以找到相對應的元素。或者，你可以在「Elements」分頁開啟的狀況下，用右鍵輕點左側原始網頁中你感興趣的內容或元素，然後再次選擇「檢查（Inspector）」，此時「Elements」分頁就會自動跳到你感興趣的內容或元素。

5.  在DevTools的選擇元素面板中，右鍵點擊選擇的元素，然後選擇「Copy」\>「Copy XPath」或「Copy」\>「Copy selector」。

6.  將複製的XPath或CSS Selector粘貼到您的爬蟲程式中，以查找和提取相應的數據。

### XPath

XPath是一種用於定位和選擇XML文檔中元素的語言，也可以應用於HTML文檔。XPath使用路徑表達式來選擇文檔中的節點或節點集，這些路徑表達式可以是絕對的或相對的，可以根據元素名、屬性、節點位置等進行篩選。XPath提供了一種簡單而強大的方式來編寫網頁爬蟲，使得開發者能夠精確地定位需要提取的數據，進而進行數據清洗和分析。

以下是一個XPath的例子：考慮一個HTML文檔，其中有一個表格，表格中包含多個行和列，每一個單元格包含一些數據。如果我們想要提取表格中第一行第一列的數據，可使用`//table/tr[1]/td[1]`。這個XPath表達式由以下幾個部分組成：

-   **`//table`**: 選擇文檔中的所有表格元素。

-   **`/tr[1]`**: 選擇表格中的第一行。

-   **`/td[1]`**: 選擇第一行中的第一列。

### CSS Selector

CSS Selector是一種用於定位和選擇HTML元素的語言，它可以根據元素的屬性、標籤名稱、類名稱等進行篩選和定位。CSS Selector同樣也是網頁爬蟲中經常使用的一種定位方式。和XPath相比，CSS Selector的寫法更加簡潔和直觀，因此在一些簡單的定位場景中，使用CSS Selector可以更加方便和快捷。但是，在一些複雜的定位場景中，XPath可能更加適合，因為它可以根據節點的位置等進行更加精確的篩選。

用CSS Selector如前面XPath的例子來選擇表格中第一行第一列：`table tr:first-child td:first-child`。這個CSS Selector由以下幾個部分組成：

-   **`table`**: 選擇文檔中的所有表格元素。

-   **`tr:first-child`**: 選擇表格中的第一行。

-   **`td:first-child`**: 選擇第一行中的第一列。
