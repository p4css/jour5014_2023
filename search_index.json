[["na-processing.html", "5.2 NA Processing", " 5.2 NA Processing 許多統計資料都會有不同程度的NA（缺失值、遺漏值）。缺失值產生的原因不一，可能有以下原因： 資料運算的時候產生的填空值。例如spread()和pivot_wider()經常會產生NA，也經常會指定值（例如0）來取代可能產生的NA。 資料紀錄的時候遺漏某些時間點的資料。 開放資料在開放時已經被整理成階層化、易於展示、一般人易懂的表格型態。此時，若將其讀入也會產生非常大量的NA。例如本章節所要提到的政府各部會預算比例。 紀錄資料筆數非常龐大、來源眾多、紀錄時間不一時，雖然有很多紀錄，但這些紀錄必須要被對齊、刪減，才能夠獲得有意義的可計算資料。例如本章節會提到的世界各國疫苗注射資料。 5.2.1 對齊資料。世界各國疫苗接種比例 https://ourworldindata.org/covid-vaccinations - https://github.com/owid/covid-19-data/tree/master/public/data/vaccinations library(lubridate) raw &lt;- read_csv(&quot;data/vaccinations.csv&quot;) fullvaccinated &lt;- raw %&gt;% select(country = location, date, people_fully_vaccinated_per_hundred) %&gt;% drop_na(people_fully_vaccinated_per_hundred) %&gt;% mutate(m = floor_date(date, unit = &quot;month&quot;)) %&gt;% group_by(country, m) %&gt;% arrange(date) %&gt;% slice(1) %&gt;% ungroup() %&gt;% select(-date) vperc_by_month &lt;- fullvaccinated %&gt;% spread(m, people_fully_vaccinated_per_hundred, fill=NA) %&gt;% gather(month, perc, -country) %&gt;% arrange(country, month) %&gt;% group_by(country) %&gt;% arrange(month) %&gt;% mutate(perc = zoo::na.locf(perc, na.rm = F)) %&gt;% ungroup() %&gt;% arrange(country, month) %&gt;% replace_na(list(perc=0)) 5.2.2 表格重整：政府預算 raw &lt;- readxl::read_excel(&quot;data/111B歲出政事別預算表.xls&quot;, skip=3, col_names = F) raw %&gt;% head(10) …1 …2 …3 …4 …5 …6 …7 …8 …9 科 目 NA NA NA NA 本年度預算數 上年度預算數 前年度決算數 本年度與上年度 比 較 款 項 目 節 名 稱 及 編 號 NA NA NA NA NA NA NA NA 合 計 2262064189 2135896877 2039353355.829 126167312 NA NA NA NA (1.一般政務支出) 210137299 202634617 190777048.02900001 7502682 1 NA NA NA 3100000000 國務支出 1210301 1186955 1176955.1259999999 23346 NA 1 NA NA 3102010000 總統府 1004797 978916 997305.54599999997 25881 NA NA 1 NA 3102010100 一般行政 920526 896334 882112.75600000005 24192 NA NA 2 NA 3102010200 國務機要 30000 30000 29993.006000000001 NA NA 3 NA 3102010300 國家慶典 15760 15760 45578.949000000001 NA NA 4 NA 3102010400 研究發展 5332 5332 6720.1840000000002 基本清理 重新命名欄位名稱 刪去被當成表格標題的多於列（通常是前兩三列）slice(-(1:2))。 觀察資料，「款」可以說是支出大類的代號，例如總統府、行政支出、立法支出、軍事支出、教育支出等。「科」為該單位底下的部門或者項目，例如「行政支出」下有行政院、主計總處支出等。更底下的細類「目」並非本例的分析對象，所以可以刪除。所以，如果款、科均為空值的話，代表其為更細的「目」。因此篩去款科為空值的所有項目。filter(!is.na(款) | !is.na(科)) 將機構id和機構名稱切分開來，視覺化的時候只會用到機構名稱。separate(機構, c(\"oid\", \"org\"), sep=\"\\n\") names(raw) &lt;- c(&quot;款&quot;, &quot;科&quot;, &quot;目&quot;, &quot;節&quot;, &quot;機構&quot;, &quot;本年度預算&quot;, &quot;上年度預算&quot;, &quot;上年度決算&quot;, &quot;預算差&quot;) cleaned &lt;- raw %&gt;% slice(-(1:2)) %&gt;% filter(!is.na(款) | !is.na(科)) %&gt;% select(-目, -節) %&gt;% separate(機構, c(&quot;oid&quot;, &quot;org&quot;), sep=&quot;\\n&quot;) cleaned %&gt;% head(10) 款 科 oid org 本年度預算 上年度預算 上年度決算 預算差 1 NA 3100000000 國務支出 1210301 1186955 1176955.1259999999 23346 NA 1 3102010000 總統府 1004797 978916 997305.54599999997 25881 NA 2 3102100000 國家安全會議 205504 208039 179649.57999999999 -2535 2 NA 3200000000 行政支出 6134276 5836481 5477154.5810000002 297795 NA 1 3203010000 行政院 1256043 1286646 1268295.23 -30603 NA 2 3203100000 主計總處 1604967 1478173 1578781.8940000001 126794 NA 3 3203300000 人事行政總處 555363 573447 489516.17700000003 -18084 NA 4 3203340000 公務人力發展學院 244346 239453 229852.26199999999 4893 NA 5 3203420000 檔案管理局 787429 646081 443133.20799999998 141348 NA 6 3203900000 大陸委員會 900896 900866 792491.22199999995 30 5.2.2.1 NA處理 觀察一下現在的資料，發現，行政院、主計總處等均屬於行政支出，但行政支出卻自有一列。依照長表格的格式來說，應嘗試把「款」作為機構的變項。所以將款的數字取代為「行政支出」等支出類別的名稱。 cleaned %&gt;% mutate(款 = ifelse(!is.na(款), org, 款)) %&gt;% head(10) 款 科 oid org 本年度預算 上年度預算 上年度決算 預算差 國務支出 NA 3100000000 國務支出 1210301 1186955 1176955.1259999999 23346 NA 1 3102010000 總統府 1004797 978916 997305.54599999997 25881 NA 2 3102100000 國家安全會議 205504 208039 179649.57999999999 -2535 行政支出 NA 3200000000 行政支出 6134276 5836481 5477154.5810000002 297795 NA 1 3203010000 行政院 1256043 1286646 1268295.23 -30603 NA 2 3203100000 主計總處 1604967 1478173 1578781.8940000001 126794 NA 3 3203300000 人事行政總處 555363 573447 489516.17700000003 -18084 NA 4 3203340000 公務人力發展學院 244346 239453 229852.26199999999 4893 NA 5 3203420000 檔案管理局 787429 646081 443133.20799999998 141348 NA 6 3203900000 大陸委員會 900896 900866 792491.22199999995 30 接下來，希望能夠在「款==NA」的地方填入該欄的「前一個值」例如行政支出。查詢一下（關鍵字如「Fill in NA column values with the last value that was not NA」）還真的有這樣的函式可以操作。 library(zoo) cleaned %&gt;% mutate(款 = ifelse(!is.na(款), org, 款)) %&gt;% mutate(款 = zoo::na.locf(款)) %&gt;% head(10) 款 科 oid org 本年度預算 上年度預算 上年度決算 預算差 國務支出 NA 3100000000 國務支出 1210301 1186955 1176955.1259999999 23346 國務支出 1 3102010000 總統府 1004797 978916 997305.54599999997 25881 國務支出 2 3102100000 國家安全會議 205504 208039 179649.57999999999 -2535 行政支出 NA 3200000000 行政支出 6134276 5836481 5477154.5810000002 297795 行政支出 1 3203010000 行政院 1256043 1286646 1268295.23 -30603 行政支出 2 3203100000 主計總處 1604967 1478173 1578781.8940000001 126794 行政支出 3 3203300000 人事行政總處 555363 573447 489516.17700000003 -18084 行政支出 4 3203340000 公務人力發展學院 244346 239453 229852.26199999999 4893 行政支出 5 3203420000 檔案管理局 787429 646081 443133.20799999998 141348 行政支出 6 3203900000 大陸委員會 900896 900866 792491.22199999995 30 太神奇了看見沒！接下來只要把「科 is NA」的那些該大類支出總數的紀錄給刪除，資料就乾淨了。最後就只會剩下一些資料清理的功伕。完整程式碼可以看下一節。 library(zoo) cleaned %&gt;% mutate(款 = ifelse(!is.na(款), org, 款)) %&gt;% mutate(款 = zoo::na.locf(款)) %&gt;% filter(!is.na(科)) %&gt;% head(10) 款 科 oid org 本年度預算 上年度預算 上年度決算 預算差 國務支出 1 3102010000 總統府 1004797 978916 997305.54599999997 25881 國務支出 2 3102100000 國家安全會議 205504 208039 179649.57999999999 -2535 行政支出 1 3203010000 行政院 1256043 1286646 1268295.23 -30603 行政支出 2 3203100000 主計總處 1604967 1478173 1578781.8940000001 126794 行政支出 3 3203300000 人事行政總處 555363 573447 489516.17700000003 -18084 行政支出 4 3203340000 公務人力發展學院 244346 239453 229852.26199999999 4893 行政支出 5 3203420000 檔案管理局 787429 646081 443133.20799999998 141348 行政支出 6 3203900000 大陸委員會 900896 900866 792491.22199999995 30 行政支出 7 3203910000 國家運輸安全調查委員會 253760 188246 168289.19099999999 65514 行政支出 8 3203920000 促進轉型正義委員會 66547 61523 101953.568 5024 5.2.2.2 完整程式碼 library(zoo) # raw &lt;- readxl::read_excel(&quot;data/111B歲出政事別預算總表.xls&quot;) raw &lt;- readxl::read_excel(&quot;data/111B歲出政事別預算表.xls&quot;, skip=3, col_names = F) names(raw) &lt;- c(&quot;款&quot;, &quot;科&quot;, &quot;目&quot;, &quot;節&quot;, &quot;機構&quot;, &quot;本年度預算&quot;, &quot;上年度預算&quot;, &quot;上年度決算&quot;, &quot;預算差&quot;) # raw$款 &lt;- na.locf(raw$款) cleaned &lt;- raw %&gt;% filter(!is.na(款) | !is.na(科)) %&gt;% slice(-(1:2)) %&gt;% select(-目, -節) %&gt;% separate(機構, c(&quot;oid&quot;, &quot;org&quot;), sep=&quot;\\n&quot;) %&gt;% mutate(款 = ifelse(!is.na(款), org, 款)) %&gt;% mutate(款 = zoo::na.locf(款)) %&gt;% filter(!is.na(科)) %&gt;% select(-科) %&gt;% type_convert() %&gt;% mutate(上年度預算 = as.numeric(上年度預算), 上年度決算 = as.integer(上年度決算), 預算差 = as.numeric(預算差)) %&gt;% replace_na(list(上年度預算 = 0, 上年度決算 = 0)) %&gt;% mutate(預算差 = 本年度預算 - 上年度預算) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
